name: Deploy to OverSkill Workers for Platforms

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        # Removed cache: 'npm' until package-lock.json is available
        
    - name: Install dependencies
      run: npm install
      
    - name: Build Vite application
      run: npm run build
      
    - name: Deploy to Workers for Platforms (Preview)
      if: github.event_name == 'pull_request'
      env:
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      run: |
        # Deploy to WFP namespace using direct API call
        NAMESPACE="overskill-development-preview"
        SCRIPT_NAME="preview-jgddne"
        
        echo "ðŸš€ Deploying to preview WFP namespace..."
        
        # Create form data for multipart upload (main module must match uploaded file name)
        curl -X PUT "https://api.cloudflare.com/client/v4/accounts/${CLOUDFLARE_ACCOUNT_ID}/workers/dispatch/namespaces/${NAMESPACE}/scripts/${SCRIPT_NAME}" \
          -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
          -H "Content-Type: multipart/form-data" \
          -F "metadata={\"main_module\":\"index.js\",\"compatibility_date\":\"2024-01-01\"}" \
          -F "index.js=@dist/index.js;type=application/javascript+module"
        
        echo "âœ… Deployed to preview: https://preview-jgddne.overskill.app"
        
    - name: Deploy to Workers for Platforms (Production)
      if: github.ref == 'refs/heads/main'
      env:
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      run: |
        # Deploy to WFP namespace using direct API call
        NAMESPACE="overskill-development-production"
        SCRIPT_NAME="jgddne"
        
        echo "ðŸš€ Deploying to production WFP namespace..."
        
        # Create form data for multipart upload (main module must match uploaded file name)
        curl -X PUT "https://api.cloudflare.com/client/v4/accounts/${CLOUDFLARE_ACCOUNT_ID}/workers/dispatch/namespaces/${NAMESPACE}/scripts/${SCRIPT_NAME}" \
          -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
          -H "Content-Type: multipart/form-data" \
          -F "metadata={\"main_module\":\"index.js\",\"compatibility_date\":\"2024-01-01\"}" \
          -F "index.js=@dist/index.js;type=application/javascript+module"
        
        echo "âœ… Deployed to production: https://jgddne.overskill.app"

    # Staging deployment (manual trigger or special branch)
    - name: Deploy to Workers for Platforms (Staging)
      if: github.ref == 'refs/heads/staging'
      env:
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      run: |
        # Deploy to WFP namespace using direct API call
        NAMESPACE="overskill-development-staging"
        SCRIPT_NAME="staging-jgddne"
        
        echo "ðŸš€ Deploying to staging WFP namespace..."
        
        # Create form data for multipart upload (main module must match uploaded file name)
        curl -X PUT "https://api.cloudflare.com/client/v4/accounts/${CLOUDFLARE_ACCOUNT_ID}/workers/dispatch/namespaces/${NAMESPACE}/scripts/${SCRIPT_NAME}" \
          -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
          -H "Content-Type: multipart/form-data" \
          -F "metadata={\"main_module\":\"index.js\",\"compatibility_date\":\"2024-01-01\"}" \
          -F "index.js=@dist/index.js;type=application/javascript+module"
        
        echo "âœ… Deployed to staging: https://staging-jgddne.overskill.app"